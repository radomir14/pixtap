<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Pixtap - Pixel Battle</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; }
        #controls { 
            position: fixed; top: 10px; left: 10px; 
            background: rgba(0,0,0,0.9); padding: 15px; 
            border-radius: 10px; color: white; z-index: 10; width: 180px;
        }
        canvas { display: block; image-rendering: pixelated; cursor: crosshair; }
        #chat-box {
            position: fixed; bottom: 10px; left: 10px;
            width: 260px; height: 220px;
            background: rgba(0,0,0,0.85); border-radius: 10px;
            display: flex; flex-direction: column; z-index: 10; border: 1px solid #333;
        }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; color: #eee; line-height: 1.4; }
        #chat-input { background: #222; border: none; color: white; padding: 12px; border-radius: 0 0 10px 10px; outline: none; border-top: 1px solid #333; }
        .stat-label { font-size: 11px; color: #888; margin-top: 10px; text-transform: uppercase; }
        #cooldown-bar { margin-top: 5px; width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        #cooldown-fill { width: 0%; height: 100%; background: #00ff00; transition: width 0.3s; }
        button { margin-top: 8px; width: 100%; padding: 7px; background: #333; color: #fff; border: 1px solid #444; border-radius: 4px; cursor: pointer; font-size: 11px; }
        input[type="color"] { width: 100%; height: 25px; border: none; background: none; cursor: pointer; margin-top: 5px; }
        .msg-line { margin-bottom: 5px; word-wrap: break-word; }
    </style>
</head>
<body>

<div id="controls">
    <div style="font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px;">PIXTAP</div>
    <div class="stat-label"><span id="l-online">Онлайн</span>: <span id="online-count" style="color:#0f0">0</span></div>
    <div class="stat-label" id="l-name-display" style="color: #55acee; font-weight: bold;">Имя: ...</div>
    <div class="stat-label" id="l-color">Цвет:</div>
    <input type="color" id="colorPicker" value="#ff0000">
    <div class="stat-label" id="coords-text">Координаты: 0, 0</div>
    <div class="stat-label" id="timer-text">Заряд: 0 / 180</div>
    <div id="cooldown-bar"><div id="cooldown-fill"></div></div>
    <button id="b-copy" onclick="copyLocation()">Копировать место</button>
    <button id="b-tele" onclick="teleportPrompt()">Телепорт</button>
</div>

<div id="chat-box">
    <div id="chat-messages"></div>
    <input type="text" id="chat-input" maxlength="100">
</div>

<canvas id="canvas"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    
    const i18n = {
        ru: { online: "Онлайн", color: "Цвет", coords: "Координаты", charge: "Заряд", bCopy: "Копировать место", bTele: "Телепорт", prompt: "Координаты (x, y):", chat: "Сообщение...", copyOk: "Скопировано!", namePrompt: "Как вас зовут?", nameLabel: "Имя" },
        en: { online: "Online", color: "Color", coords: "Coordinates", charge: "Charge", bCopy: "Copy location", bTele: "Teleport", prompt: "Coords (x, y):", chat: "Type message...", copyOk: "Copied!", namePrompt: "What is your name?", nameLabel: "Name" }
    };

    const userLang = navigator.language || navigator.userLanguage;
    const lang = (userLang.startsWith('ru') || userLang.startsWith('uk') || userLang.startsWith('be')) ? 'ru' : 'en';
    const t = i18n[lang];

    // Логика имени БЕЗ памяти (localStorage убран)
    let userName = prompt(t.namePrompt);
    if (!userName || userName.trim() === "") {
        userName = "Аноним_" + Math.floor(Math.random()*100);
    }
    document.getElementById('l-name-display').innerText = `${t.nameLabel}: ${userName}`;

    document.getElementById('l-online').innerText = t.online;
    document.getElementById('l-color').innerText = t.color;
    document.getElementById('b-copy').innerText = t.bCopy;
    document.getElementById('b-tele').innerText = t.bTele;
    document.getElementById('chat-input').placeholder = t.chat;

    // Холст
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const PIXEL_SIZE = 20;
    let scale = 1, offsetX = window.innerWidth/2, offsetY = window.innerHeight/2;
    let pixels = {}, currentCooldown = 0;

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(offsetX, offsetY);
        ctx.scale(scale, scale);
        for (let key in pixels) {
            const [x, y] = key.split(',').map(Number);
            ctx.fillStyle = pixels[key];
            ctx.fillRect(x * PIXEL_SIZE, y * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
        }
        ctx.restore();
        const cx = Math.floor((-offsetX + window.innerWidth/2) / (scale * PIXEL_SIZE));
        const cy = Math.floor((-offsetY + window.innerHeight/2) / (scale * PIXEL_SIZE));
        document.getElementById('coords-text').innerText = `${t.coords}: ${cx}, ${cy}`;
    }

    // Чат
    const chatInput = document.getElementById('chat-input');
    const chatMsgs = document.getElementById('chat-messages');

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && chatInput.value.trim()) {
            socket.emit('chat_message', { text: chatInput.value, room: lang, name: userName });
            chatInput.value = '';
        }
    });

    socket.on('chat_receive_' + lang, (msg) => {
        const d = document.createElement('div');
        d.className = "msg-line";
        d.innerHTML = `<b style="color: #55acee">${msg.name}:</b> ${msg.text}`;
        chatMsgs.appendChild(d);
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
    });

    // Утилиты
    function copyLocation() {
        const cx = Math.floor((-offsetX + window.innerWidth/2) / (scale * PIXEL_SIZE));
        const cy = Math.floor((-offsetY + window.innerHeight/2) / (scale * PIXEL_SIZE));
        const url = new URL(window.location.href);
        url.searchParams.set('x', cx); url.searchParams.set('y', cy);
        navigator.clipboard.writeText(url.toString());
        alert(t.copyOk);
    }

    function teleportPrompt() {
        const res = prompt(t.prompt);
        if (res) {
            const [x, y] = res.split(',').map(n => parseInt(n.trim()));
            if (!isNaN(x) && !isNaN(y)) {
                offsetX = (window.innerWidth/2) - (x * PIXEL_SIZE * scale);
                offsetY = (window.innerHeight/2) - (y * PIXEL_SIZE * scale);
                draw();
            }
        }
    }

    socket.on('init_board', (data) => { pixels = data; draw(); jump(); });
    socket.on('update_pixel', (d) => { pixels[`${d.x},${d.y}`] = d.color; draw(); });
    socket.on('online_count', (c) => document.getElementById('online-count').innerText = c);
    socket.on('cooldown_update', (d) => {
        currentCooldown = d.current;
        document.getElementById('cooldown-fill').style.width = (currentCooldown/180)*100 + '%';
        document.getElementById('timer-text').innerText = `${t.charge}: ${currentCooldown} / 180`;
    });

    function jump() {
        const p = new URLSearchParams(window.location.search);
        const x = parseInt(p.get('x')), y = parseInt(p.get('y'));
        if(!isNaN(x)) { offsetX = (window.innerWidth/2) - (x*PIXEL_SIZE*scale); offsetY = (window.innerHeight/2) - (y*PIXEL_SIZE*scale); draw(); }
    }

    window.addEventListener('wheel', e => { scale *= e.deltaY > 0 ? 0.9 : 1.1; draw(); }, {passive:true});
    canvas.addEventListener('mousedown', e => {
        if (e.button === 0) {
            const wx = Math.floor(((e.clientX - offsetX) / scale) / PIXEL_SIZE);
            const wy = Math.floor(((e.clientY - offsetY) / scale) / PIXEL_SIZE);
            socket.emit('place_pixel', { x: wx, y: wy, color: document.getElementById('colorPicker').value });
        }
    });
    let drag = false;
    canvas.addEventListener('mousedown', e => { if(e.button>0) drag = true; });
    window.addEventListener('mouseup', () => drag = false);
    window.addEventListener('mousemove', e => { if(drag) { offsetX += e.movementX; offsetY += e.movementY; draw(); } });
    window.oncontextmenu = () => false;
    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; draw(); });
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
</script>
</body>
</html>